{% extends "base.html" %}
{% block title %}لاگ‌ها | Social Admin{% endblock %}
{% block page_title %}گزارش اجرای پردازه‌ها{% endblock %}
{% block page_subtitle %}آخرین رویدادها و خطاهای سیستم را مرور کنید{% endblock %}
{% block content %}
<section class="panel">
    <header class="panel-header">
        <div>
            <h2>فایل‌های لاگ</h2>
            <p class="panel-description">حداکثر ده فایل اخیر نمایش داده می‌شود</p>
        </div>
    </header>
    {% if log_files %}
        <div class="logs">
            {% for log in log_files %}
                <details class="log-entry" data-log-name="{{ log.name }}" {% if loop.first %}open{% endif %}>
                    <summary>
                        <span class="log-name">{{ log.name }}</span>
                        <span class="log-date">آخرین تغییر: {{ log.modified_display }}</span>
                    </summary>
                    <p class="log-stream-status" data-log-status>در حال بارگیری داده‌های اولیه…</p>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>سطح</th>
                                    <th>زمان</th>
                                    <th>پیام</th>
                                    <th>جزئیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in log.entries %}
                                    <tr>
                                        <td><span class="badge badge-{{ entry.badge_class }}">{{ entry.level }}</span></td>
                                        <td>{{ entry.timestamp }}</td>
                                        <td>{{ entry.message }}</td>
                                        <td>
                                            {% if entry.details %}
                                                <pre class="log-details">{{ entry.details }}</pre>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </details>
            {% endfor %}
        </div>
    {% else %}
        <p class="empty">لاگی برای نمایش وجود ندارد.</p>
    {% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
    {{ super() }}
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const MAX_ROWS = 50;

            const createCell = (contentBuilder) => {
                const cell = document.createElement("td");
                contentBuilder(cell);
                return cell;
            };

            const buildRow = (entry) => {
                const row = document.createElement("tr");

                row.appendChild(
                    createCell((cell) => {
                        const badge = document.createElement("span");
                        const badgeClass = entry.badge_class ? `badge-${entry.badge_class}` : "badge-secondary";
                        badge.className = `badge ${badgeClass}`;
                        badge.textContent = entry.level || "";
                        cell.appendChild(badge);
                    }),
                );

                row.appendChild(
                    createCell((cell) => {
                        cell.textContent = entry.timestamp || "";
                    }),
                );

                row.appendChild(
                    createCell((cell) => {
                        cell.textContent = entry.message || "";
                    }),
                );

                row.appendChild(
                    createCell((cell) => {
                        if (entry.details) {
                            const pre = document.createElement("pre");
                            pre.className = "log-details";
                            pre.textContent = entry.details;
                            cell.appendChild(pre);
                        } else {
                            cell.textContent = "-";
                        }
                    }),
                );

                row.classList.add("log-entry-row-new");
                setTimeout(() => row.classList.remove("log-entry-row-new"), 2000);

                return row;
            };

            document.querySelectorAll(".log-entry[data-log-name]").forEach((details) => {
                const logName = details.getAttribute("data-log-name");
                const tableBody = details.querySelector("tbody");
                const statusEl = details.querySelector("[data-log-status]");
                if (!logName || !tableBody || !statusEl) {
                    return;
                }

                let eventSource = null;
                let reconnectTimer = null;

                const updateStatus = (text, state) => {
                    statusEl.textContent = text;
                    if (state) {
                        statusEl.dataset.state = state;
                    } else {
                        delete statusEl.dataset.state;
                    }
                };

                const closeStream = () => {
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                };

                const scheduleReconnect = () => {
                    closeStream();
                    if (reconnectTimer) {
                        clearTimeout(reconnectTimer);
                    }
                    reconnectTimer = setTimeout(connect, 5000);
                };

                const appendEntry = (entry) => {
                    const row = buildRow(entry);
                    tableBody.insertBefore(row, tableBody.firstChild);

                    while (tableBody.childElementCount > MAX_ROWS) {
                        tableBody.removeChild(tableBody.lastElementChild);
                    }
                };

                const connect = () => {
                    closeStream();
                    if (reconnectTimer) {
                        clearTimeout(reconnectTimer);
                        reconnectTimer = null;
                    }

                    const url = `/logs/${encodeURIComponent(logName)}/stream`;
                    eventSource = new EventSource(url);
                    updateStatus("اتصال برقرار شد و منتظر رویدادهای جدید هستیم…", "connected");

                    eventSource.onmessage = (event) => {
                        try {
                            const entry = JSON.parse(event.data);
                            appendEntry(entry);
                            updateStatus("به‌روزرسانی خودکار فعال است", "connected");
                        } catch (error) {
                            console.error("Failed to parse log entry", error);
                        }
                    };

                    eventSource.onerror = () => {
                        updateStatus("ارتباط با جریان لاگ قطع شد. تلاش برای اتصال مجدد…", "disconnected");
                        scheduleReconnect();
                    };
                };

                details.addEventListener("toggle", () => {
                    if (details.open) {
                        connect();
                    } else {
                        updateStatus("برای مشاهده به‌روزرسانی لحظه‌ای، لاگ را باز کنید.", "paused");
                        closeStream();
                        if (reconnectTimer) {
                            clearTimeout(reconnectTimer);
                            reconnectTimer = null;
                        }
                    }
                });

                if (details.open) {
                    connect();
                } else {
                    updateStatus("برای مشاهده به‌روزرسانی لحظه‌ای، لاگ را باز کنید.", "paused");
                }
            });
        });
    </script>
{% endblock %}
