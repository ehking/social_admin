{% extends "base.html" %}
{% block title %}تنظیمات | Social Admin{% endblock %}
{% block page_title %}تنظیمات و توکن‌های سرویس{% endblock %}
{% block page_subtitle %}کلیدهای دسترسی به سرویس‌ها را مدیریت کنید{% endblock %}
{% block content %}
<section class="panel">
    <header class="panel-header">
        <div>
            <h2>افزودن یا ویرایش توکن</h2>
            <p class="panel-description">کلیدهایی که برای ارتباط با سرویس‌ها استفاده می‌شوند</p>
        </div>
    </header>
    <form method="post" action="/settings" class="form-grid">
        <div class="form-field">
            <label for="name">نام سرویس</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div class="form-field">
            <label for="key">کلید</label>
            <input type="text" id="key" name="key" required>
        </div>
        <div class="form-field full">
            <label for="value">مقدار</label>
            <textarea id="value" name="value" rows="3" required></textarea>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn">ذخیره</button>
        </div>
    </form>
</section>
{% if role_definitions and menu_definitions %}
<section class="panel">
    <header class="panel-header">
        <div>
            <h2>دسترسی به منوها</h2>
            <p class="panel-description">کنترل کنید هر نقش به کدام بخش‌های پنل دسترسی داشته باشد</p>
        </div>
    </header>
    <form method="post" action="/settings/permissions" class="form-grid">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>منو</th>
                        {% for role in role_definitions %}
                            <th>{{ role.label }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for menu in menu_definitions %}
                        <tr>
                            <td>{{ menu.label }}</td>
                            {% for role in role_definitions %}
                                {% set field_name = 'perm-' ~ role.value ~ '-' ~ menu.key.value %}
                                {% set role_permissions = permission_matrix.get(role.value, {}) %}
                                {% set is_allowed = role_permissions.get(menu.key.value) %}
                                <td class="text-center">
                                    {% if role.editable %}
                                        <input type="checkbox" id="{{ field_name }}" name="{{ field_name }}" value="1" {% if is_allowed %}checked{% endif %}>
                                    {% else %}
                                        <span class="badge badge-secondary">همیشه فعال</span>
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn">ذخیره دسترسی‌ها</button>
        </div>
    </form>
</section>
{% endif %}
<section class="panel">
    <header class="panel-header">
        <div>
            <h2>توکن‌های ذخیره شده</h2>
            <p class="panel-description">کلیدهای موجود در سیستم</p>
        </div>
    </header>
    {% if tokens %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>نام</th>
                        <th>کلید</th>
                        <th>تاریخ ایجاد</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for token in tokens %}
                        <tr>
                            <td>{{ token.name }}</td>
                            <td>{{ token.key }}</td>
                            <td>{{ token.created_at.strftime('%Y-%m-%d %H:%M') if token.created_at else '' }}</td>
                            <td class="actions">
                                <form method="post" action="/settings/delete" onsubmit="return confirm('توکن حذف شود؟');">
                                    <input type="hidden" name="token_id" value="{{ token.id }}">
                                    <button type="submit" class="btn btn-small btn-danger">حذف</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="empty">توکن فعالی ثبت نشده است.</p>
    {% endif %}
</section>
{% endblock %}
