{% extends "base.html" %}
{% block title %}لاگ‌ها | Social Admin{% endblock %}
{% block page_title %}گزارش اجرای پردازه‌ها{% endblock %}
{% block page_subtitle %}آخرین رویدادها و خطاهای سیستم را مرور کنید{% endblock %}
{% block content %}
{% set default_tab = 'jobs' if log_files else 'api' %}
<section class="panel">
    <header class="panel-header">
        <div>
            <h2>لاگ‌ها</h2>
            <p class="panel-description">گزارش پردازه‌ها و درخواست‌های API را در تب‌های مجزا مرور کنید</p>
        </div>
    </header>
    <div class="log-tabs" id="log-tabs" data-default-tab="{{ default_tab }}">
        <div class="log-tabs-nav" role="tablist">
            <button
                type="button"
                class="log-tab-button {% if default_tab == 'jobs' %}is-active{% endif %}"
                data-log-tab-button="jobs"
                role="tab"
                aria-controls="jobs-log-panel"
                {% if default_tab == 'jobs' %}aria-selected="true"{% else %}aria-selected="false"{% endif %}
            >
                پردازه‌ها
            </button>
            <button
                type="button"
                class="log-tab-button {% if default_tab == 'api' %}is-active{% endif %}"
                data-log-tab-button="api"
                role="tab"
                aria-controls="api-log-panel"
                {% if default_tab == 'api' %}aria-selected="true"{% else %}aria-selected="false"{% endif %}
            >
                درخواست‌های API
            </button>
        </div>
        <div class="log-tab-panels">
            <div
                id="jobs-log-panel"
                class="log-tab-panel {% if default_tab == 'jobs' %}is-active{% endif %}"
                data-log-tab-panel="jobs"
                role="tabpanel"
                {% if default_tab != 'jobs' %}hidden{% endif %}
            >
                {% if log_files %}
                    <div class="logs">
                        {% for log in log_files %}
                            <details class="log-entry" data-log-name="{{ log.name }}" {% if loop.first and default_tab == 'jobs' %}open{% endif %}>
                                <summary>
                                    <span class="log-name">{{ log.name }}</span>
                                    <span class="log-date">آخرین تغییر: {{ log.modified_display }}</span>
                                </summary>
                                <p class="log-stream-status" data-log-status>در حال بارگیری داده‌های اولیه…</p>
                                <div class="table-wrapper">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>سطح</th>
                                                <th>زمان</th>
                                                <th>پیام</th>
                                                <th>جزئیات</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for entry in log.entries %}
                                                <tr>
                                                    <td><span class="badge badge-{{ entry.badge_class }}">{{ entry.level }}</span></td>
                                                    <td>{{ entry.timestamp }}</td>
                                                    <td>{{ entry.message }}</td>
                                                    <td>
                                                        {% if entry.details %}
                                                            <pre class="log-details">{{ entry.details }}</pre>
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </details>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty">لاگی برای نمایش وجود ندارد.</p>
                {% endif %}
            </div>
            <div
                id="api-log-panel"
                class="log-tab-panel {% if default_tab == 'api' %}is-active{% endif %}"
                data-log-tab-panel="api"
                role="tabpanel"
                {% if default_tab != 'api' %}hidden{% endif %}
            >
                {% if api_entries %}
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>سطح</th>
                                    <th>زمان</th>
                                    <th>رویداد</th>
                                    <th>جزئیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in api_entries %}
                                    <tr>
                                        <td><span class="badge badge-{{ entry.badge_class }}">{{ entry.level }}</span></td>
                                        <td>{{ entry.timestamp }}</td>
                                        <td>{{ entry.message }}</td>
                                        <td>
                                            {% if entry.details %}
                                                <pre class="log-details">{{ entry.details }}</pre>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="empty">درخواستی برای نمایش وجود ندارد.</p>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
    {{ super() }}
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const MAX_ROWS = 50;

            const tabContainer = document.getElementById("log-tabs");
            if (tabContainer) {
                const defaultTab = tabContainer.dataset.defaultTab || "jobs";
                const tabButtons = tabContainer.querySelectorAll("[data-log-tab-button]");
                const tabPanels = tabContainer.querySelectorAll("[data-log-tab-panel]");

                const activateTab = (name) => {
                    tabButtons.forEach((button) => {
                        const isActive = button.getAttribute("data-log-tab-button") === name;
                        button.classList.toggle("is-active", isActive);
                        button.setAttribute("aria-selected", isActive ? "true" : "false");
                        button.setAttribute("tabindex", isActive ? "0" : "-1");
                    });

                    tabPanels.forEach((panel) => {
                        const isActive = panel.getAttribute("data-log-tab-panel") === name;
                        panel.classList.toggle("is-active", isActive);
                        panel.hidden = !isActive;
                    });
                };

                activateTab(defaultTab);

                tabButtons.forEach((button) => {
                    button.addEventListener("click", () => {
                        const target = button.getAttribute("data-log-tab-button");
                        if (target) {
                            activateTab(target);
                        }
                    });
                });
            }

            const createCell = (contentBuilder) => {
                const cell = document.createElement("td");
                contentBuilder(cell);
                return cell;
            };

            const buildRow = (entry) => {
                const row = document.createElement("tr");

                row.appendChild(
                    createCell((cell) => {
                        const badge = document.createElement("span");
                        const badgeClass = entry.badge_class ? `badge-${entry.badge_class}` : "badge-secondary";
                        badge.className = `badge ${badgeClass}`;
                        badge.textContent = entry.level || "";
                        cell.appendChild(badge);
                    }),
                );

                row.appendChild(
                    createCell((cell) => {
                        cell.textContent = entry.timestamp || "";
                    }),
                );

                row.appendChild(
                    createCell((cell) => {
                        cell.textContent = entry.message || "";
                    }),
                );

                row.appendChild(
                    createCell((cell) => {
                        if (entry.details) {
                            const pre = document.createElement("pre");
                            pre.className = "log-details";
                            pre.textContent = entry.details;
                            cell.appendChild(pre);
                        } else {
                            cell.textContent = "-";
                        }
                    }),
                );

                row.classList.add("log-entry-row-new");
                setTimeout(() => row.classList.remove("log-entry-row-new"), 2000);

                return row;
            };

            document.querySelectorAll(".log-entry[data-log-name]").forEach((details) => {
                const logName = details.getAttribute("data-log-name");
                const tableBody = details.querySelector("tbody");
                const statusEl = details.querySelector("[data-log-status]");
                if (!logName || !tableBody || !statusEl) {
                    return;
                }

                let eventSource = null;
                let reconnectTimer = null;

                const updateStatus = (text, state) => {
                    statusEl.textContent = text;
                    if (state) {
                        statusEl.dataset.state = state;
                    } else {
                        delete statusEl.dataset.state;
                    }
                };

                const closeStream = () => {
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                };

                const scheduleReconnect = () => {
                    closeStream();
                    if (reconnectTimer) {
                        clearTimeout(reconnectTimer);
                    }
                    reconnectTimer = setTimeout(connect, 5000);
                };

                const appendEntry = (entry) => {
                    const row = buildRow(entry);
                    tableBody.insertBefore(row, tableBody.firstChild);

                    while (tableBody.childElementCount > MAX_ROWS) {
                        tableBody.removeChild(tableBody.lastElementChild);
                    }
                };

                const connect = () => {
                    closeStream();
                    if (reconnectTimer) {
                        clearTimeout(reconnectTimer);
                        reconnectTimer = null;
                    }

                    const url = `/logs/${encodeURIComponent(logName)}/stream`;
                    eventSource = new EventSource(url);
                    updateStatus("اتصال برقرار شد و منتظر رویدادهای جدید هستیم…", "connected");

                    eventSource.onmessage = (event) => {
                        try {
                            const entry = JSON.parse(event.data);
                            appendEntry(entry);
                            updateStatus("به‌روزرسانی خودکار فعال است", "connected");
                        } catch (error) {
                            console.error("Failed to parse log entry", error);
                        }
                    };

                    eventSource.onerror = () => {
                        updateStatus("ارتباط با جریان لاگ قطع شد. تلاش برای اتصال مجدد…", "disconnected");
                        scheduleReconnect();
                    };
                };

                details.addEventListener("toggle", () => {
                    if (details.open) {
                        connect();
                    } else {
                        updateStatus("برای مشاهده به‌روزرسانی لحظه‌ای، لاگ را باز کنید.", "paused");
                        closeStream();
                        if (reconnectTimer) {
                            clearTimeout(reconnectTimer);
                            reconnectTimer = null;
                        }
                    }
                });

                if (details.open) {
                    connect();
                } else {
                    updateStatus("برای مشاهده به‌روزرسانی لحظه‌ای، لاگ را باز کنید.", "paused");
                }
            });
        });
    </script>
{% endblock %}
