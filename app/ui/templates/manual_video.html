{% extends "base.html" %}
{% block title %}ویدیو دستی | Social Admin{% endblock %}
{% block page_title %}ایجاد ویدیو به صورت دستی{% endblock %}
{% block page_subtitle %}یک کمپین جدید ایجاد کنید و ویدیو را برای پردازش ثبت نمایید{% endblock %}
{% block content %}
<section class="panel">
    <header class="panel-header">
        <div>
            <h2>اطلاعات ویدیو</h2>
            <p class="panel-description">جزئیات ویدیو و کمپین را تکمیل کنید</p>
        </div>
    </header>
    <form method="post" action="/manual-video" class="form-grid">
        <div class="form-field">
            <label for="title">عنوان ویدیو <span class="required-marker" aria-hidden="true">*</span><span class="sr-only">فیلد اجباری</span></label>
            <input type="text" id="title" name="title" value="{{ manual_video_defaults.title }}" required>
        </div>
        <div class="form-field">
            <label for="media_url">لینک فایل ویدیو <span class="required-marker" aria-hidden="true">*</span><span class="sr-only">فیلد اجباری</span></label>
            <input type="url" id="media_url" name="media_url" placeholder="https://..." value="{{ manual_video_defaults.media_url }}" required>
        </div>
        <div class="form-field">
            <label for="media_type">نوع رسانه</label>
            <input type="text" id="media_type" name="media_type" value="{{ manual_video_defaults.media_type }}">
        </div>
        <div class="form-field">
            <label for="ai_tool">ابزار هوش مصنوعی مورد استفاده <span class="required-marker" aria-hidden="true">*</span><span class="sr-only">فیلد اجباری</span></label>
            <select id="ai_tool" name="ai_tool" required>
                <option value="" disabled {% if not manual_video_defaults.ai_tool %}selected{% endif %}>انتخاب ابزار</option>
                {% for tool in ai_tools %}
                    <option value="{{ tool }}" {% if manual_video_defaults.ai_tool == tool %}selected{% endif %}>{{ tool }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-field full">
            <label for="description">توضیحات ویدیو</label>
            <textarea id="description" name="description" rows="3" placeholder="توضیحات اختیاری">{{ manual_video_defaults.description }}</textarea>
        </div>
        <div class="form-field">
            <label for="campaign_name">نام کمپین <span class="required-marker" aria-hidden="true">*</span><span class="sr-only">فیلد اجباری</span></label>
            <input type="text" id="campaign_name" name="campaign_name" value="{{ manual_video_defaults.campaign_name }}" required>
        </div>
        <div class="form-field full">
            <label for="campaign_description">توضیحات کمپین</label>
            <textarea id="campaign_description" name="campaign_description" rows="3">{{ manual_video_defaults.campaign_description }}</textarea>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn">ثبت ویدیو</button>
        </div>
    </form>
</section>
<section class="panel">
    <header class="panel-header">
        <div>
            <h2>نمونه ویدیوهای ساخته شده با هوش مصنوعی</h2>
            <p class="panel-description">
                برای الهام گرفتن می‌توانید نمونه‌های آماده را مشاهده کنید یا لینک آن‌ها را در فرم بالا استفاده نمایید.
            </p>
        </div>
    </header>
    <div class="sample-video-grid" role="list">
        {% for video in sample_ai_videos %}
            <article class="sample-video-card" role="listitem">
                <div class="sample-video-thumbnail" style="background-image: url('{{ video.thumbnail_url }}');">
                    <span class="sample-video-duration" aria-label="مدت زمان ویدیو">{{ video.duration }}</span>
                </div>
                <div class="sample-video-body">
                    <h3 class="sample-video-title">{{ video.title }}</h3>
                    <p class="sample-video-description">{{ video.description }}</p>
                    <div class="sample-video-actions">
                        <a class="btn btn-secondary btn-small" href="{{ video.video_url }}" target="_blank" rel="noopener">
                            مشاهده ویدیو
                        </a>
                        <a
                            class="btn btn-small"
                            href="{{ video.video_url }}"
                            download
                            rel="noopener"
                        >
                            دانلود ویدیو
                        </a>
                        <button
                            class="btn btn-small btn-copy"
                            type="button"
                            data-video-url="{{ video.video_url }}"
                            aria-label="کپی لینک ویدیو"
                        >
                            کپی لینک
                        </button>
                    </div>
                </div>
            </article>
        {% endfor %}
    </div>
</section>
<section class="panel">
    <header class="panel-header">
        <div>
            <h2>آخرین درخواست‌ها</h2>
            <p class="panel-description">نظارت بر وضعیت پردازش ویدیوهای ثبت‌شده</p>
        </div>
    </header>
    {% if jobs %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>عنوان</th>
                        <th>کمپین</th>
                        <th>ابزار هوش مصنوعی</th>
                        <th>وضعیت</th>
                        <th>مرحله جاری</th>
                        <th>جزئیات خطا</th>
                        <th>پیشرفت</th>
                        <th>پیش‌نمایش</th>
                        <th>تاریخ ایجاد</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in jobs %}
                        <tr>
                            <td>{{ job.title }}</td>
                            <td>{{ job.campaign_name or '-' }}</td>
                            <td>{{ job.ai_tool }}</td>
                            <td><span class="badge {{ job.status_badge_class }}">{{ job.status_label }}</span></td>
                            <td>
                                <div class="job-stage">
                                    <strong>{{ job.stage_label }}</strong>
                                    <p class="job-stage-hint">{{ job.stage_hint }}</p>
                                </div>
                            </td>
                            <td>
                                {% if job.error_message %}
                                    <div class="job-error">
                                        <span class="job-error-message">{{ job.error_message }}</span>
                                        {% if job.error_code %}
                                            <span class="job-error-code">({{ job.error_code }})</span>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="empty">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="status-progress" aria-label="پیشرفت پردازش">
                                    <div
                                        class="progress-track"
                                        role="progressbar"
                                        aria-valuenow="{{ job.progress_percent }}"
                                        aria-valuemin="0"
                                        aria-valuemax="100"
                                    >
                                        <div class="progress-value" style="width: {{ job.progress_percent }}%;"></div>
                                    </div>
                                    <div class="progress-meta">
                                        <span class="progress-percent">{{ job.progress_percent }}%</span>
                                        <span class="progress-description">{{ job.progress_description }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if job.local_preview_url or job.media_preview_url %}
                                    <div class="job-preview">
                                        <video
                                            controls
                                            preload="metadata"
                                            src="{{ job.local_preview_url or job.media_preview_url }}"
                                            class="job-preview-video"
                                        ></video>
                                        <div class="job-preview-actions">
                                            <a
                                                class="btn btn-secondary btn-small"
                                                href="{{ job.local_preview_url or job.media_preview_url }}"
                                                download
                                            >
                                                دانلود ویدیو
                                            </a>
                                            <a
                                                class="btn btn-small"
                                                href="{{ job.local_preview_url or job.media_preview_url }}"
                                                target="_blank"
                                                rel="noopener"
                                            >
                                                مشاهده در پنجره جدید
                                            </a>
                                        </div>
                                        {% if job.local_preview_path %}
                                            <small class="job-preview-path">مسیر ذخیره سازی: {{ job.local_preview_path }}</small>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="empty">پیش‌نمایشی موجود نیست</span>
                                {% endif %}
                            </td>
                            <td>{{ job.created_at.strftime('%Y-%m-%d %H:%M') if job.created_at else '' }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="empty">درخواستی برای نمایش وجود ندارد.</p>
    {% endif %}
</section>
{% endblock %}
{% block extra_scripts %}
    <script>
        (() => {
            const copyButtons = document.querySelectorAll('.btn-copy');
            const resetDelay = 2000;

            const resetButton = (button) => {
                button.classList.remove('is-copied');
                button.textContent = 'کپی لینک';
            };

            copyButtons.forEach((button) => {
                button.addEventListener('click', async () => {
                    const videoUrl = button.dataset.videoUrl;
                    if (!videoUrl) {
                        return;
                    }
                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(videoUrl);
                            button.classList.add('is-copied');
                            button.textContent = 'کپی شد!';
                        } else {
                            window.prompt('برای کپی لینک را انتخاب و تایید کنید:', videoUrl);
                            button.classList.add('is-copied');
                            button.textContent = 'لینک آماده است';
                        }
                        setTimeout(() => resetButton(button), resetDelay);
                    } catch (err) {
                        console.error('Failed to copy video url', err);
                        button.textContent = 'کپی در دسترس نیست';
                        setTimeout(() => resetButton(button), resetDelay);
                    }
                });
            });
        })();
    </script>
{% endblock %}
